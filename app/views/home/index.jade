extends ../shared/layouts/application

block scripts
	- if (current_user)
		script.
			var _currentUserId = !{current_user.id};
	- if (room)
		script.
			var _preloadedRoomId = !{room.id};

	script(src='/javascript/application.js')

block content
	div#huddle-app

	script#huddle-template(type='text/ractive')
		div#huddle-app-container.flexbox.huddle-container
			div#left-sidebar.flexitem.sidebar.sidebar-left
				section
					<Rooms />
				section
					<Conversations />

			div#chat-area-container.flexitem.chat-area
				<Chat />
	
	script#chat-template(type='text/ractive')
		section#chat-container
			{{ #if chat.id }}
			{{ >Room }}
			{{ elseif chat.user }}
			{{ >Message }}
			{{ else }}
			p Nothing selected.
			{{ /if }}

	script#room-template(type='text/ractive')
		header.room-header
			div.room-header-inner
				//- i.fa.fa-lock.fa-2x
				div.page-header-main
					h3 {{ activeRoom.name }}
					p {{ activeRoom.description }}
		section#room-container.flexbox.room-container
			div#chat-message-area.flexitem.chat-message-area
				<Messages/>

			div#sidebar-right.flexitem.sidebar-right
				<Users>

	script#room-users-template(type='text/ractive')
		div#chat-users.users
			ul.users-list.sidebar-nav
				{{ #each users }}
				<RoomUser user="{{ . }}">
				{{ /each }}

	script#room-user-template(type='text/ractive')
		li.user-information
			div.user-metadata
				a(href='/chat/user/{{ id }}' on-click="privateMessage:{{ user }}")
					i.fa.fa-circle(class="{{ status }}")
					| {{ displayName }}

	script#room-messages-template(type='text/ractive')
		div.scroll-wrapper
			div.flexbox.chat-message-wrapper
				div#chat-messages.flexitem.messages
					{{ #each messages:i }}
					div#chat-message-container.message-container.flexbox(class = "{{ from_user ? 'server-message' : '' }}{{ _.pluck(tags, 'name').join(' ') }} {{ user.id === ~/current_user.id ? 'current-user' : '' }}")
						div#chat-username.flexitem.username 
							{{ #if messages.length > 0 && (i === 0 || !previousMessageFromCurrentUser(messages[i - 1].user.id, user.id)) }}
							{{ user.displayName }}
							{{ /if }}
						div#chat-message.flexitem.message {{{ html }}}
						div#chat-timestamp.flexitem.timestamp(title="{{ timeAgoInWords(created_at) }}") {{ formatTime(created_at) }}
					{{ /each }}
		{{ >ChatInput }}
		
	script#chat-input-template(type='text/ractive')
		div#chat-input-area.flexitem.chat-input-container
			form(action='/rooms/1/messages' method='POST' on-submit="messageSubmit")
				textarea#message-input.huddle-message-input(autofocus='true', value="{{ messageInput }}", on-keypress="typing" on-keydown-input="set('messageInput', event.node.value)")

	script#message-template(type='text/ractive')
		section.message-container
			p Private Message

	script#new-room-template(type='text/ractive')
		div#new-room-container
			h4 Create a New Room

			form(action="/rooms" method="POST")
				div.form-group
					label(for="name") Name
					input(type="text" placeholder="")
				div.form-group
					label(for="description") Description
					input(type="text")
				button(type="submit") Create Room

	script#conversations-template(type='text/ractive')
		section#conversations-container.conversations-wrapper
			ul#conversations-list.conversations-container.sidebar-nav
				li.sidebar-heading
					strong Conversations
				{{ #each conversations }}
				li.user-name
					a(href="/chat/users/{{ user.id }}", class="" on-click="loadChat:{{ . }}") {{ user.displayName }}
				{{ /each }}

	script#rooms-template(type='text/ractive')
		div#active-rooms.rooms-wrapper
			ul#rooms-container.rooms-container.sidebar-nav
				li.sidebar-heading 
					strong Rooms
				{{ #each rooms }}
				li#room-name.room-name
					a(href="/rooms/{{ id }}", class="{{ this === activeRoom ? 'active' : '' }}", on-click="loadChat:{{ . }}") {{ name }}
				{{ /each}}
				li#new-room
					a(href='#' on-click="newRoom") 
						i.fa.fa-plus
						|  New Room